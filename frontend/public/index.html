<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>File Upload</title>
</head>

<body>
  <h1>Upload File</h1>
  <form id="upload-form" enctype="multipart/form-data">
    <input type="file" name="file" required />
    <button type="submit">Upload</button>
  </form>

  <div id="result" style="margin-top: 20px; font-weight: bold;"></div>

  <script>
    const form = document.getElementById('upload-form');
    const result = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fileInput = form.querySelector('input[type="file"]');
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);

      result.innerText = "Uploading file...";

      try {
        // 1. Upload the file to the server
        const uploadRes = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        const uploadData = await uploadRes.json();

        if (!uploadRes.ok) {
          throw new Error(uploadData.error || 'Upload error');
        }

        // 2. Wait for inspector to return file size
        const maxRetries = 20;
        let retries = 0;
        let fileSize = null;

        while (retries < maxRetries && fileSize === null) {
          await new Promise(r => setTimeout(r, 1000)); // wait 1 second

          const sizesRes = await fetch('/sizes');
          const sizesData = await sizesRes.json();
          if (sizesData[file.name]) {
            fileSize = sizesData[file.name];
          }

          retries++;
        }

        if (fileSize !== null) {
          result.innerText = `File "${file.name}" size: ${fileSize} bytes`;
        } else {
          result.innerText = `⚠️ File size for "${file.name}" not received. Please try again later.`;
        }

      } catch (err) {
        console.error(err);
        result.innerText = '❌ Error: ' + err.message;
      }
    });
  </script>
</body>

</html>